name: ğŸš€ Deploy to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
  SERVICE_ID: srv-d2kbhnruibrs73emmc8g

jobs:
  test:
    name: ğŸ§ª Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ğŸ“¦ Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ”¨ Run Tests (Backend)
      run: mvn clean test -B

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'

    - name: ğŸ“¦ Install Frontend Dependencies
      run: |
        cd frontend
        npm ci

    - name: ğŸ§ª Run Tests (Frontend)
      run: |
        cd frontend
        npm run test

    - name: ğŸ—ï¸ Build Frontend
      run: |
        cd frontend
        npm run build

  deploy:
    name: ğŸš€ Deploy to Render
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to Render
      run: |
        curl -X POST "https://api.render.com/v1/services/$SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}'

    - name: â³ Wait for deployment
      run: |
        echo "Deploy iniciado! Monitorando status..."
        for i in {1..30}; do
          STATUS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$SERVICE_ID" | \
            jq -r '.service.serviceDetails.status // "unknown"')
          
          echo "Status: $STATUS (tentativa $i/30)"
          
          if [ "$STATUS" = "available" ]; then
            echo "âœ… Deploy concluÃ­do com sucesso!"
            exit 0
          elif [ "$STATUS" = "deploy_failed" ]; then
            echo "âŒ Deploy falhou!"
            exit 1
          fi
          
          sleep 10
        done
        
        echo "â° Timeout aguardando deploy"
        exit 1

    - name: ğŸ¥ Health Check
      run: |
        echo "Verificando saÃºde do serviÃ§o..."
        for i in {1..10}; do
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://gestao-de-pedidos.onrender.com/health || echo "000")
          echo "Health check: HTTP $HTTP_STATUS (tentativa $i/10)"
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… ServiÃ§o funcionando corretamente!"
            exit 0
          fi
          
          sleep 15
        done
        
        echo "âŒ Health check falhou"
        exit 1

  notify:
    name: ğŸ“¢ Notification
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Deploy Success
      if: needs.deploy.result == 'success'
      run: echo "ğŸ‰ Deploy realizado com sucesso! https://gestao-de-pedidos.onrender.com"

    - name: ğŸ“¢ Deploy Failure
      if: needs.deploy.result == 'failure'
      run: echo "âŒ Falha no deploy. Verifique os logs."